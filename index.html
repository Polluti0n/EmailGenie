<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Email Reply Generator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" />
  <link rel="stylesheet" href="./css/tabler-themes.css" />
  <link rel="stylesheet" href="./css/base.css" />
  <link rel="stylesheet" href="./css/loader.css" />
</head>

<body>
  <!-- BEGIN GLOBAL THEME SCRIPT -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script src="./js/emailgenie-theme.js" defer></script>
  <script type="module" src="./js/loader.js"></script>
  <!-- END GLOBAL THEME SCRIPT -->

  <div class="page">

    <div class="page-wrapper p-2">
              <div class="row row-deck row-cards" id="card-deck">
        </div>
        </div>
              <div id="" class="card">
        <ul class="nav nav-pills card-footer-pills text-center nav-justified">
          <li class="nav-item">
            <a class="nav-link" href="#">
              <div class="col">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-sparkles"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path
                    d="M16 18a2 2 0 0 1 2 2a2 2 0 0 1 2 -2a2 2 0 0 1 -2 -2a2 2 0 0 1 -2 2zm0 -12a2 2 0 0 1 2 2a2 2 0 0 1 2 -2a2 2 0 0 1 -2 -2a2 2 0 0 1 -2 2zm-7 12a6 6 0 0 1 6 -6a6 6 0 0 1 -6 -6a6 6 0 0 1 -6 6a6 6 0 0 1 6 6z"
                  ></path>
                </svg>
                <div>Improve</div>
              </div></a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <div class="col">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-writing"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path
                    d="M20 17v-12c0 -1.121 -.879 -2 -2 -2s-2 .879 -2 2v12l2 2l2 -2z"
                  ></path>
                  <path d="M16 7h4"></path>
                  <path
                    d="M18 19h-13a2 2 0 1 1 0 -4h4a2 2 0 1 0 0 -4h-3"
                  ></path>
                </svg>
                <div>Reply</div>
              </div></a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <div class="col">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-at"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"></path>
                  <path
                    d="M16 12v1.5a2.5 2.5 0 0 0 5 0v-1.5a9 9 0 1 0 -5.5 8.28"
                  ></path>
                </svg>
                <div>Compose</div>
              </div></a
            >
          </li>

          <li class="nav-item">
            <a class="nav-link"
                    data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasSettings">
              <div class="col">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon icon-1"
                >
                  <path
                    d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z"
                  ></path>
                  <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"></path>
                </svg>
                <div>Settings</div>
              </div></a
            >
          </li>
        </ul>
      </div>
  </div>
        
 

  <!-- BEGIN SETTINGS CONTAINER  -->
  <div id="settingsContainer" class="settings">
    <form class="offcanvas offcanvas-end offcanvas-narrow" tabindex="-1" id="offcanvasSettings">
      <div class="offcanvas-header">
        <h2 class="offcanvas-title">Settings</h2>
      </div>
      <div class="offcanvas-body d-flex flex-column">
        <div class="accordion" id="settings-accordion">
          <div class="accordion-item">
            <div class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapse-theme-settings" aria-expanded="false">
                App Theme
                <div class="accordion-button-toggle">
                  <!-- Download SVG icon from http://tabler.io/icons/icon/chevron-down -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="icon icon-1">
                    <path d="M6 9l6 6l6 -6"></path>
                  </svg>
                </div>
              </button>
            </div>
            <div id="collapse-theme-settings" class="accordion-collapse collapse" data-bs-parent="#settings-accordian">
              <div class="accordion-body">
                <div class="mb-4">
                  <label class="form-label">Color mode</label>
                  <p class="form-hint">Which color mode do you prefer?</p>
                  <label class="form-check">
                    <div class="form-selectgroup-item">
                      <input type="radio" name="theme" value="light" class="form-check-input" checked="" />
                      <div class="form-check-label">Light</div>
                    </div>
                  </label>
                  <label class="form-check">
                    <div class="form-selectgroup-item">
                      <input type="radio" name="theme" value="dark" class="form-check-input" />
                      <div class="form-check-label">Dark</div>
                    </div>
                  </label>
                </div>
                <div class="mb-4">
                  <label class="form-label">Color scheme</label>
                  <p class="form-hint">
                    Pick the highlight color you prefer.
                  </p>
                  <div class="row g-2">
                    <div class="col-auto">
                      <label class="form-colorinput">
                        <input name="theme-primary" type="radio" value="blue" class="form-colorinput-input" />
                        <span class="form-colorinput-color bg-blue"></span>
                      </label>
                    </div>
                    <div class="col-auto">
                      <label class="form-colorinput">
                        <input name="theme-primary" type="radio" value="azure" class="form-colorinput-input" />
                        <span class="form-colorinput-color bg-azure"></span>
                      </label>
                    </div>
                    <div class="col-auto">
                      <label class="form-colorinput">
                        <input name="theme-primary" type="radio" value="indigo" class="form-colorinput-input" />
                        <span class="form-colorinput-color bg-indigo"></span>
                      </label>
                    </div>
                    <div class="col-auto">
                      <label class="form-colorinput">
                        <input name="theme-primary" type="radio" value="purple" class="form-colorinput-input" />
                        <span class="form-colorinput-color bg-purple"></span>
                      </label>
                    </div>
                    <div class="col-auto">
                      <label class="form-colorinput">
                        <input name="theme-primary" type="radio" value="pink" class="form-colorinput-input" />
                        <span class="form-colorinput-color bg-pink"></span>
                      </label>
                    </div>
                    <div class="col-auto">
                      <label class="form-colorinput">
                        <input name="theme-primary" type="radio" value="red" class="form-colorinput-input" />
                        <span class="form-colorinput-color bg-red"></span>
                      </label>
                    </div>
                    <div class="col-auto">
                      <label class="form-colorinput">
                        <input name="theme-primary" type="radio" value="orange" class="form-colorinput-input" />
                        <span class="form-colorinput-color bg-orange"></span>
                      </label>
                    </div>
                    <div class="col-auto">
                      <label class="form-colorinput">
                        <input name="theme-primary" type="radio" value="yellow" class="form-colorinput-input" />
                        <span class="form-colorinput-color bg-yellow"></span>
                      </label>
                    </div>
                    <div class="col-auto">
                      <label class="form-colorinput">
                        <input name="theme-primary" type="radio" value="lime" class="form-colorinput-input" />
                        <span class="form-colorinput-color bg-lime"></span>
                      </label>
                    </div>
                    <div class="col-auto">
                      <label class="form-colorinput">
                        <input name="theme-primary" type="radio" value="green" class="form-colorinput-input" />
                        <span class="form-colorinput-color bg-green"></span>
                      </label>
                    </div>
                    <div class="col-auto">
                      <label class="form-colorinput">
                        <input name="theme-primary" type="radio" value="teal" class="form-colorinput-input" />
                        <span class="form-colorinput-color bg-teal"></span>
                      </label>
                    </div>
                    <div class="col-auto">
                      <label class="form-colorinput">
                        <input name="theme-primary" type="radio" value="cyan" class="form-colorinput-input" />
                        <span class="form-colorinput-color bg-cyan"></span>
                      </label>
                    </div>
                  </div>
                </div>
                <div class="mb-4">
                  <label class="form-label">Theme base</label>
                  <p class="form-hint">Choose the gray shade you like..</p>
                  <div>
                    <label class="form-check">
                      <div class="form-selectgroup-item">
                        <input type="radio" name="theme-base" value="slate" class="form-check-input" />
                        <div class="form-check-label">Slate</div>
                      </div>
                    </label>
                    <label class="form-check">
                      <div class="form-selectgroup-item">
                        <input type="radio" name="theme-base" value="gray" class="form-check-input" checked="" />
                        <div class="form-check-label">Gray</div>
                      </div>
                    </label>
                    <label class="form-check">
                      <div class="form-selectgroup-item">
                        <input type="radio" name="theme-base" value="zinc" class="form-check-input" />
                        <div class="form-check-label">Zinc</div>
                      </div>
                    </label>
                    <label class="form-check">
                      <div class="form-selectgroup-item">
                        <input type="radio" name="theme-base" value="neutral" class="form-check-input" />
                        <div class="form-check-label">Neutral</div>
                      </div>
                    </label>
                    <label class="form-check">
                      <div class="form-selectgroup-item">
                        <input type="radio" name="theme-base" value="stone" class="form-check-input" />
                        <div class="form-check-label">Stone</div>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="accordion-item">
            <div class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapse-signature-settings" aria-expanded="false">
                Signature
                <div class="accordion-button-toggle">
                  <!-- Download SVG icon from http://tabler.io/icons/icon/chevron-down -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="icon icon-1">
                    <path d="M6 9l6 6l6 -6"></path>
                  </svg>
                </div>
              </button>
            </div>
            <div id="collapse-signature-settings" class="accordion-collapse collapse"
              data-bs-parent="#settings-accordian">
              <div class="accordion-body">
                <div class="mb-4">
                  <label class="row"><label class="col form-label">Include</label>
                    <span class="col-auto">
                      <label class="form-check form-check-single form-switch">
                        <input id="includeSigChk" class="form-check-input" type="checkbox" checked="" />
                      </label> </span></label>
                  <p class="form-hint">
                    Preview of the signature that will be used.
                  </p>
                  <div class="row g-2">
                    <div id="signature-thumbnail-container"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-auto space-y">
        <button type="button" class="btn w-100" id="reset-changes">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
            <path d="M19.95 11a8 8 0 1 0 -.5 4m.5 5v-5h-5"></path>
          </svg>
          Reset changes
        </button>
        <a href="#" class="btn btn-primary w-100" data-bs-dismiss="offcanvas">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
            <path
              d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z">
            </path>
            <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"></path>
          </svg>
          Save settings
        </a>
      </div>
    </form>
  </div>
  <!-- END SETTINGS CONTAINER  -->

  <!-- BEGIN LOADING SPINNER  -->



  <!-- BEGIN GLOBAL MANDATORY SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- END GLOBAL MANDATORY SCRIPTS -->

  <!-- BEGIN MANDATORY PAGE THEME SCRIPT -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
  var themeConfig = {
    theme: "light",
    "theme-base": "gray",
    "theme-font": "sans-serif",
    "theme-primary": "blue",
    "theme-radius": "1",
  };

  var url = new URL(window.location);
  var form = document.getElementById("offcanvasSettings");
  var resetButton = document.getElementById("reset-changes");

  var applyThemeValue = function (key, value) {
    document.documentElement.setAttribute("data-bs-" + key, value);
    window.localStorage.setItem("tabler-" + key, value);
    Office.context.roamingSettings.set("tabler-" + key, value);
    
  };

  var checkItems = function () {
    for (var key in themeConfig) {
      let stored =
        Office.context.roamingSettings.get("tabler-" + key) ||
        window.localStorage.getItem("tabler-" + key) ||
        themeConfig[key];

      if (stored) {
        document.documentElement.setAttribute("data-bs-" + key, stored);

        var radios = form.querySelectorAll(`[name="${key}"]`);
        if (radios) {
          radios.forEach((radio) => {
            radio.checked = radio.value === stored;
          });
        }
      }
    }
  };

  form.addEventListener("change", function (event) {
    var target = event.target,
      name = target.name,
      value = target.value;

    for (var key in themeConfig) {
      if (name === key) {
        applyThemeValue(key, value);
        url.searchParams.set(key, value);
      }
    }
    Office.context.roamingSettings.saveAsync(); // persist settings
  });

  resetButton.addEventListener("click", function () {
    for (var key in themeConfig) {
      var defaultValue = themeConfig[key];
      document.documentElement.removeAttribute("data-bs-" + key);
      window.localStorage.removeItem("tabler-" + key);
      Office.context.roamingSettings.remove("tabler-" + key);
      url.searchParams.delete(key);
    }

    Office.context.roamingSettings.saveAsync(); // persist settings
    checkItems();
  });

  Office.onReady(function () {
    checkItems();
  });
});
  </script>
  <!-- END MANDATORY PAGE THEME SCRIPT -->

  <!-- BEGIN PAGE SCRIPT -->
  <script>
  import createLoader from './loader.js';

let originalEmailBody = "";
let pollingInterval = null;

Office.onReady((info) => {
  if (info.host === Office.HostType.Outlook) {
    
    // Start polling only on the index page
    if (window.location.pathname.endsWith("/index.html")) {
      
      startEmailPolling();
    }

    // Optional: Monitor URL changes (for SPA-style apps)
    const observer = new MutationObserver(() => {
      if (window.location.pathname.endsWith("/index.html")) {
        if (!pollingInterval) startEmailPolling();
      } else {
        stopEmailPolling();
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  }
});

function startEmailPolling() {
  pollingInterval = setInterval(() => {
    try {
      Office.context.mailbox.item.body.getAsync(
        Office.CoercionType.Text,
        (result) => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            const currentBody = result.value;
            if (currentBody !== originalEmailBody) {
              originalEmailBody = currentBody;
       
              onEmailChanged();
            }
          } else {
            console.warn("Polling: Failed to get email body:", result.error.message);
          }
        }
      );
    } catch (err) {
      console.error("Polling error:", err);
    }
  }, 2000); // Poll every 2 seconds
}

function stopEmailPolling() {
  if (pollingInterval) {
    clearInterval(pollingInterval);
    pollingInterval = null;
  }
}

function onEmailChanged() {
  const startLoading = createLoader();
  startLoading(() => {
    return getEmailAnalysis();
  });
}


  
async function getEmailAnalysis() {
  const data = { "emailText": originalEmailBody };
        try {
          const response = await fetch(
            "https://prod-37.westus.logic.azure.com:443/workflows/3a0de62053ca46169b669d6abcf4fc8d/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=usG50jhh1f4Z1578OhwqoR5kOIcYyg1GKMWKmD2zROc",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            }
          );

          const result = await response.json();
          console.log("Response:", result);
          if (result.success) {
            return renderEmailAnalysis(result.reply);
          } else {
            console.error("Error in response:", result.error);
          }
        } catch (error) {
          console.error("Error fetching data:", error);
        }
        finally {
          const stopLoading = createLoader();
          stopLoading();
        }
}


 function renderEmailAnalysis(data) {
    const container = document.getElementById("card-deck");
    container.innerHTML = ""; // Clear existing content
    
    // === Sentiment Card ===
    const sentimentColors = {
      Positive: "bg-green",
      Negative: "bg-red",
      Neutral: "bg-yellow"
    };
    
    const sentimentIcon = {
      
      Positive: `<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-mood-smile"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M9 10l.01 0" /><path d="M15 10l.01 0" /><path d="M9.5 15a3.5 3.5 0 0 0 5 0" /></svg>`,
      Negative: `<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-mood-sad"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M9 10l.01 0" /><path d="M15 10l.01 0" /><path d="M9.5 15.25a3.5 3.5 0 0 1 5 0" /></svg>`,
      Neutral: `<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-mood-empty"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M9 10l.01 0" /><path d="M15 10l.01 0" /><path d="M9 15l6 0" /></svg>`
    }
    
    const sentimentCard = document.createElement("div");
    sentimentCard.className = "card";
    sentimentCard.innerHTML = `
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-auto">
          <span class="${sentimentColors[data.sentiment] || "bg-gray"} text-white avatar">
            ${sentimentIcon[data.sentiment] || "" }
            </span>
            </div>
            <div class="col">
              <div class="font-weight-medium">${data.sentiment}</div>
              <div class="text-secondary">Email Sentiment</div>
              </div>
              </div>
              </div>
              `;
              container.appendChild(sentimentCard);
              
                  // === Summary Card ===
                  const summaryCard = document.createElement("div");
                  summaryCard.className = "card";
                  summaryCard.innerHTML = `
                    <div class="card-body">
                      <div class="col">
                        <div class="mb-1 col">Summary</div>
                        <div class="text-secondary w-100">${data.summary}</div>
                      </div>
                    </div>
                  `;
                  container.appendChild(summaryCard);
              
    // === Quick Reply Card ===
    const quickReplyCard = document.createElement("div");
    quickReplyCard.className = "card";

    const replies = Array.isArray(data.responses)
      ? data.responses.map(
          r => `<span class="list-group-item text-secondary rounded p-2" aria-current="true">${r.item || ''}</span>`
        ).join("")
      : '<span class="text-secondary">No responses available</span>';

    quickReplyCard.innerHTML = `
      <div class="card-body">
        <div class="mb-1 col">Quick Reply</div>
        <div class="list-group list-group-flush">
          ${replies}
        </div>
      </div>
      <div class="d-flex"></div>
    `;
    container.appendChild(quickReplyCard);
  }


    window.onload = () =>
      document.getElementById("loadingSpinner").classList.remove("show");

    // Show/hide custom fields
    const showOtherInput = (selectId, inputId) => {
      document
        .getElementById(selectId)
        .addEventListener("change", function () {
          const input = document.getElementById(inputId);
          if (this.value === "Other") {
            input.classList.remove("d-none");
            input.required = true;
          } else {
            input.classList.add("d-none");
            input.required = false;
            input.value = "";
          }
        });
    };

    showOtherInput("emailAudience", "audienceOther");
    showOtherInput("emailTone", "toneOther");
    showOtherInput("emailType", "typeOther");

    let templateContent = "";
    const templateDiv = document.getElementById("templateContent");
    templateDiv.addEventListener("paste", (event) => {
      event.preventDefault();
      templateContent = event.clipboardData.getData("text/plain");
      templateDiv.innerHTML = event.clipboardData.getData("text/html");
    });

    document
      .getElementById("replyForm")
      .addEventListener("submit", async function (e) {
        e.preventDefault();

        const formContainer = document.getElementById("formContainer");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const previewEmail = document.getElementById("emailPreview");

        formContainer.classList.add("blurred");
        loadingSpinner.classList.add("show");

        const emailAudience =
          document.getElementById("emailAudience").value === "Other"
            ? document.getElementById("audienceOther").value
            : document.getElementById("emailAudience").value;

        const emailTone =
          document.getElementById("emailTone").value === "Other"
            ? document.getElementById("toneOther").value
            : document.getElementById("emailTone").value;

        const emailType =
          document.getElementById("emailType").value === "Other"
            ? document.getElementById("typeOther").value
            : document.getElementById("emailType").value;

        const emailDescription =
          document.getElementById("emailDescription").value;

        const replyPrompt = {
          audience: emailAudience,
          tone: emailTone,
          type: emailType,
          description: emailDescription,
          template: templateContent,
          originalEmail: originalEmailBody,
        };

        try {
          const response = await fetch(
            "https://prod-145.westus.logic.azure.com:443/workflows/c65d371e274a4a29a0daa3ee25ce63bd/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=-skVHfpWefHb6DNSYMWTmkI3mEUObkxnK2wAvBwU-wg",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(replyPrompt),
            }
          );

          const result = await response.json();

          if (result.success && result.reply) {
            loadingSpinner.classList.remove("show");
            formContainer.classList.remove("active", "blurred");
            previewEmail.classList.add("active");

            if (Office.context.roamingSettings.get("includeSignature")) {
              const signature =
                Office.context.roamingSettings.get("userSignature") ||
                result.reply.signature;
              const newBody = result.reply.body + "<br>" + signature;
              result.reply.body = newBody;
            }

            previewEmail.innerHTML = `
            <div class="card-body fade-in">
                <h2 class="mb-4">Generated Reply</h2>
                <label class="mb-1">Subject:</label>
                <div class="card mb-3">
                  <div class="card-body overflow-scroll">
                    ${result.reply.subject}
                  </div>
                </div>
                <label class="mb-1">Body:</label>
                <div class="card mb-3">
                  <div class="card-body overflow-scroll">
                    ${result.reply.body}
                  </div>
                </div>
              <div class="card-footer bg-transparent mt-auto">
              <div class="btn-list justify-content-end">
                <a href="#" class="btn btn-1" id="cancelReplyButton">Cancel</a>
                <a href="#" class="btn btn-success btn-2" id="insertReplyButton">Insert into Email</a>
              </div>
            </div>
            </div>
          `;

            document
              .getElementById("insertReplyButton")
              .addEventListener("click", function () {
                const item = Office.context.mailbox.item;

                if (
                  Office.context.mailbox.item.itemType ===
                  Office.MailboxEnums.ItemType.Message &&
                  typeof item.body.setSelectedDataAsync === "function"
                ) {
                  // Compose mode: insert text directly
                  item.body.setSelectedDataAsync(
                    insertReplyHtml,
                    { coercionType: Office.CoercionType.Text },
                    function (asyncResult) {
                      if (
                        asyncResult.status ===
                        Office.AsyncResultStatus.Succeeded
                      ) {
                        console.log("Reply inserted!");
                      } else {
                        console.error(
                          "Failed to insert reply:",
                          asyncResult.error.message
                        );
                      }
                    }
                  );
                } else {
                  // Not in compose mode, launch new message
                  Office.context.mailbox.item.displayReplyAllFormAsync(
                    {
                      htmlBody: result.reply.body,
                    },
                    function (asyncResult) {
                      if (
                        asyncResult.status ===
                        Office.AsyncResultStatus.Succeeded
                      ) {
                        console.log("Reply inserted!");
                      } else {
                        console.error(
                          "Failed to insert reply:",
                          asyncResult.error.message
                        );
                      }
                    }
                  );
                }
                previewEmail.innerHTML = "";
                goHome();
              });

            document
              .getElementById("cancelReplyButton")
              .addEventListener("click", function () {
                previewEmail.innerHTML = "";
                goHome();
              });

            document
              .getElementById("emailPreview")
              .scrollIntoView({ behavior: "smooth" });
          } else {
            console.log("Something went wrong. No reply text received.");
          }
        } catch (err) {
          console.error("Fetch error:", err);
          console.log("An error occurred while generating the reply.");
        }
      });

    function convertEscapedToHtml(input, options = {}) {
      if (!input || typeof input !== "string") return "";

      if (options.usePre) {
        return `<pre>${escapeHtml(input)}</pre>`;
      }

      return escapeHtml(input)
        .replace(/\n/g, "<br>")
        .replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function showSettings() {
      document.querySelector(".view.active").classList.remove("active");
      document.getElementById("settingsContainer").classList.add("active");
      const signatureHtml =
        Office.context.roamingSettings.get("userSignature") || "";
      document.getElementById("signatureInput").innerHTML = signatureHtml;
    }

    function goHome() {
      document.querySelector(".view.active").classList.remove("active");
      document.getElementById("formContainer").classList.add("active");
    }

    function saveSettings() {
      const signatureHtml =
        document.getElementById("signatureInput").innerHTML;
      const signatureSwitch =
        document.getElementById("includeSigChk").checked;

      Office.context.roamingSettings.set("userSignature", signatureHtml);
      Office.context.roamingSettings.set("includeSignature", signatureSwitch);

      Office.context.roamingSettings.saveAsync((result) => {
        if (result.status === Office.AsyncResultStatus.Succeeded) {
          console.log("Settings saved successfully.");
          goHome();
        } else {
          console.log("Failed to save settings.");
        }
      });

      goHome();
    }
  </script>
  <script>
    Office.onReady(() => {
      document.getElementById("openDialog").onclick = () => {
        Office.context.ui.displayDialogAsync(
          "https://polluti0n.github.io/EmailGenie/dialog.html",
          { height: 50, width: 50 },
          function (asyncResult) {
            if (asyncResult.status === Office.AsyncResultStatus.Succeeded) {
              const dialog = asyncResult.value;

              dialog.addEventHandler(
                Office.EventType.DialogMessageReceived,
                function (arg) {
                  console.log("Message from dialog:", arg.message);
                  dialog.close();
                }
              );
            } else {
              console.error(
                "Failed to open dialog:",
                asyncResult.error.message
              );
            }
          }
        );
      };
    });
  </script>
  <!-- END PAGE SCRIPT -->
</body>

</html>