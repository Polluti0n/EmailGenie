<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Email Reply Generator</title>
    <!--
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css"
    />

    <style>
      .view {
        display: none;
      }
      .view.active {
        display: block;
      }
      #signatureInput {
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 100px;
      }

      .blurred {
        filter: blur(4px);
        pointer-events: none;
        user-select: none;
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .slide-up {
        animation: slideUp 0.5s forwards;
      }

      @keyframes slideUp {
        from {
          opacity: 1;
          transform: translateY(0);
          max-height: 1000px;
        }

        to {
          opacity: 0;
          transform: translateY(-50px);
          max-height: 0;
          overflow: hidden;
        }
      }

      #loadingSpinner {
        position: fixed;
        background: rgba(255, 255, 255, 0.7);
        z-index: 1050;
        top: 50%;
        left: 50%;
        translate: -50% -50%;
      }

      pre {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body class="p-4">
    <script src="./js/emailgenie-theme.js"></script>
    <div
      id="loadingSpinner"
      class="d-flex justify-content-center align-items-center fade"
    >
      <div
        class="spinner-border text-primary"
        role="status"
        style="width: 4rem; height: 4rem"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <header class="navbar-expand">
      <div class="navbar">
        <div class="container-xl">
          <div class="row flex-column flex-md-row flex-fill align-items-center">
            <div class="col">
              <!-- BEGIN NAVBAR MENU -->
              <ul class="navbar-nav">
                <li class="nav-item">
                  <a class="nav-link" href="./">
                    <span class="nav-link-title">Reply</span>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="./compose.html">
                    <span class="nav-link-title">Compose</span>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="./summarize.html">
                    <span class="nav-link-title">Summarize</span>
                  </a>
                </li>
              </ul>
              <!-- END NAVBAR MENU -->
            </div>
            <div class="col col-md-auto">
              <ul class="navbar-nav">
                <li class="nav-item">
                  <a
                    class="nav-link"
                    href="#"
                    data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasSettings"
                  >
                    <span class="nav-link-title">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="icon icon-1"
                      >
                        <path
                          d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z"
                        ></path>
                        <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"></path>
                      </svg>
                    </span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div id="settingsContainer" class="settings">
      <form
        class="offcanvas offcanvas-start offcanvas-narrow"
        tabindex="-1"
        id="offcanvasSettings"
      >
        <div class="offcanvas-header">
          <h2 class="offcanvas-title">Settings</h2>
        </div>
        <div class="offcanvas-body d-flex flex-column">
          <div class="accordion" id="settings-accordion">
            <div class="accordion-item">
              <div class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapse-theme-settings"
                  aria-expanded="false"
                >
                  App Theme
                  <div class="accordion-button-toggle">
                    <!-- Download SVG icon from http://tabler.io/icons/icon/chevron-down -->
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="icon icon-1"
                    >
                      <path d="M6 9l6 6l6 -6"></path>
                    </svg>
                  </div>
                </button>
              </div>
              <div
                id="collapse-theme-settings"
                class="accordion-collapse collapse"
                data-bs-parent="#settings-accordian"
              >
                <div class="accordion-body">
                  <div class="mb-4">
                    <label class="form-label">Color mode</label>
                    <p class="form-hint">Which color mode do you prefer?</p>
                    <label class="form-check">
                      <div class="form-selectgroup-item">
                        <input
                          type="radio"
                          name="theme"
                          value="light"
                          class="form-check-input"
                          checked=""
                        />
                        <div class="form-check-label">Light</div>
                      </div>
                    </label>
                    <label class="form-check">
                      <div class="form-selectgroup-item">
                        <input
                          type="radio"
                          name="theme"
                          value="dark"
                          class="form-check-input"
                        />
                        <div class="form-check-label">Dark</div>
                      </div>
                    </label>
                  </div>
                  <div class="mb-4">
                    <label class="form-label">Color scheme</label>
                    <p class="form-hint">
                      Pick the highlight color you prefer.
                    </p>
                    <div class="row g-2">
                      <div class="col-auto">
                        <label class="form-colorinput">
                          <input
                            name="theme-primary"
                            type="radio"
                            value="blue"
                            class="form-colorinput-input"
                          />
                          <span class="form-colorinput-color bg-blue"></span>
                        </label>
                      </div>
                      <div class="col-auto">
                        <label class="form-colorinput">
                          <input
                            name="theme-primary"
                            type="radio"
                            value="azure"
                            class="form-colorinput-input"
                          />
                          <span class="form-colorinput-color bg-azure"></span>
                        </label>
                      </div>
                      <div class="col-auto">
                        <label class="form-colorinput">
                          <input
                            name="theme-primary"
                            type="radio"
                            value="indigo"
                            class="form-colorinput-input"
                          />
                          <span class="form-colorinput-color bg-indigo"></span>
                        </label>
                      </div>
                      <div class="col-auto">
                        <label class="form-colorinput">
                          <input
                            name="theme-primary"
                            type="radio"
                            value="purple"
                            class="form-colorinput-input"
                          />
                          <span class="form-colorinput-color bg-purple"></span>
                        </label>
                      </div>
                      <div class="col-auto">
                        <label class="form-colorinput">
                          <input
                            name="theme-primary"
                            type="radio"
                            value="pink"
                            class="form-colorinput-input"
                          />
                          <span class="form-colorinput-color bg-pink"></span>
                        </label>
                      </div>
                      <div class="col-auto">
                        <label class="form-colorinput">
                          <input
                            name="theme-primary"
                            type="radio"
                            value="red"
                            class="form-colorinput-input"
                          />
                          <span class="form-colorinput-color bg-red"></span>
                        </label>
                      </div>
                      <div class="col-auto">
                        <label class="form-colorinput">
                          <input
                            name="theme-primary"
                            type="radio"
                            value="orange"
                            class="form-colorinput-input"
                          />
                          <span class="form-colorinput-color bg-orange"></span>
                        </label>
                      </div>
                      <div class="col-auto">
                        <label class="form-colorinput">
                          <input
                            name="theme-primary"
                            type="radio"
                            value="yellow"
                            class="form-colorinput-input"
                          />
                          <span class="form-colorinput-color bg-yellow"></span>
                        </label>
                      </div>
                      <div class="col-auto">
                        <label class="form-colorinput">
                          <input
                            name="theme-primary"
                            type="radio"
                            value="lime"
                            class="form-colorinput-input"
                          />
                          <span class="form-colorinput-color bg-lime"></span>
                        </label>
                      </div>
                      <div class="col-auto">
                        <label class="form-colorinput">
                          <input
                            name="theme-primary"
                            type="radio"
                            value="green"
                            class="form-colorinput-input"
                          />
                          <span class="form-colorinput-color bg-green"></span>
                        </label>
                      </div>
                      <div class="col-auto">
                        <label class="form-colorinput">
                          <input
                            name="theme-primary"
                            type="radio"
                            value="teal"
                            class="form-colorinput-input"
                          />
                          <span class="form-colorinput-color bg-teal"></span>
                        </label>
                      </div>
                      <div class="col-auto">
                        <label class="form-colorinput">
                          <input
                            name="theme-primary"
                            type="radio"
                            value="cyan"
                            class="form-colorinput-input"
                          />
                          <span class="form-colorinput-color bg-cyan"></span>
                        </label>
                      </div>
                    </div>
                  </div>
                  <div class="mb-4">
                    <label class="form-label">Theme base</label>
                    <p class="form-hint">Choose the gray shade you like..</p>
                    <div>
                      <label class="form-check">
                        <div class="form-selectgroup-item">
                          <input
                            type="radio"
                            name="theme-base"
                            value="slate"
                            class="form-check-input"
                          />
                          <div class="form-check-label">Slate</div>
                        </div>
                      </label>
                      <label class="form-check">
                        <div class="form-selectgroup-item">
                          <input
                            type="radio"
                            name="theme-base"
                            value="gray"
                            class="form-check-input"
                            checked=""
                          />
                          <div class="form-check-label">Gray</div>
                        </div>
                      </label>
                      <label class="form-check">
                        <div class="form-selectgroup-item">
                          <input
                            type="radio"
                            name="theme-base"
                            value="zinc"
                            class="form-check-input"
                          />
                          <div class="form-check-label">Zinc</div>
                        </div>
                      </label>
                      <label class="form-check">
                        <div class="form-selectgroup-item">
                          <input
                            type="radio"
                            name="theme-base"
                            value="neutral"
                            class="form-check-input"
                          />
                          <div class="form-check-label">Neutral</div>
                        </div>
                      </label>
                      <label class="form-check">
                        <div class="form-selectgroup-item">
                          <input
                            type="radio"
                            name="theme-base"
                            value="stone"
                            class="form-check-input"
                          />
                          <div class="form-check-label">Stone</div>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <div class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapse-signature-settings"
                  aria-expanded="false"
                >
                  Signature
                  <div class="accordion-button-toggle">
                    <!-- Download SVG icon from http://tabler.io/icons/icon/chevron-down -->
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="icon icon-1"
                    >
                      <path d="M6 9l6 6l6 -6"></path>
                    </svg>
                  </div>
                </button>
              </div>
              <div
                id="collapse-signature-settings"
                class="accordion-collapse collapse"
                data-bs-parent="#settings-accordian"
              >
                <div class="accordion-body">
                  <div class="mb-4">
                    <label class="row"
                      ><label class="col form-label">Include</label>
                      <span class="col-auto">
                        <label class="form-check form-check-single form-switch">
                          <input
                            id="includeSigChk"
                            class="form-check-input"
                            type="checkbox"
                            checked=""
                          />
                        </label> </span
                    ></label>
                    <p class="form-hint">
                      Preview of the signature that will be used.
                    </p>
                    <div class="row g-2">
                      <div id="signature-thumbnail-container"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-auto space-y">
          <button type="button" class="btn w-100" id="reset-changes">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-1"
            >
              <path d="M19.95 11a8 8 0 1 0 -.5 4m.5 5v-5h-5"></path>
            </svg>
            Reset changes
          </button>
          <a href="#" class="btn btn-primary w-100" data-bs-dismiss="offcanvas">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-1"
            >
              <path
                d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z"
              ></path>
              <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"></path>
            </svg>
            Save settings
          </a>
        </div>
      </form>
    </div>

    <div id="settingsContainer" class="view">
      <div class="card-body">
        <h2 class="mb-4">Settings</h2>

        <div class="mb-3">
          <h3 class="card-title mt-4">Signatures</h3>
          <label class="row mb-3">
            <span class="col">Include Signature</span>
            <span class="col-auto">
              <label class="form-check form-check-single form-switch">
                <input
                  id="includeSigChk"
                  class="form-check-input"
                  type="checkbox"
                  checked=""
                />
              </label>
            </span>
          </label>
          <div
            class="col overflow-scroll"
            id="signatureInput"
            contenteditable="true"
          >
            Paste your Outlook signature here...
          </div>
        </div>
      </div>
      <div class="card-footer bg-transparent mt-auto">
        <div class="btn-list justify-content-end">
          <a href="#" class="btn btn-1" id="cancelSettingsBtn"> Cancel </a>
          <a href="#" class="btn btn-primary btn-2" id="saveSettingsBtn"
            >Save</a
          >
        </div>
      </div>
    </div>

    <div id="formContainer" class="view active">
      <div class="card-body">
        <div class="mb-4 d-flex justify-content-between">
          <h2 class="col">Reply Detail</h2>
          <a id="settingsBtn">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="icon icon-tabler icons-tabler-filled icon-tabler-settings"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path
                d="M14.647 4.081a.724 .724 0 0 0 1.08 .448c2.439 -1.485 5.23 1.305 3.745 3.744a.724 .724 0 0 0 .447 1.08c2.775 .673 2.775 4.62 0 5.294a.724 .724 0 0 0 -.448 1.08c1.485 2.439 -1.305 5.23 -3.744 3.745a.724 .724 0 0 0 -1.08 .447c-.673 2.775 -4.62 2.775 -5.294 0a.724 .724 0 0 0 -1.08 -.448c-2.439 1.485 -5.23 -1.305 -3.745 -3.744a.724 .724 0 0 0 -.447 -1.08c-2.775 -.673 -2.775 -4.62 0 -5.294a.724 .724 0 0 0 .448 -1.08c-1.485 -2.439 1.305 -5.23 3.744 -3.745a.722 .722 0 0 0 1.08 -.447c.673 -2.775 4.62 -2.775 5.294 0zm-2.647 4.919a3 3 0 1 0 0 6a3 3 0 0 0 0 -6z"
              ></path>
            </svg>
          </a>
        </div>

        <div class="mb-3">
          <form id="replyForm">
            <div class="mb-3 form-floating">
              <select class="form-select" id="emailAudience" required="">
                <option value="">Select...</option>
                <option value="Client">Client</option>
                <option value="Coworker">Coworker</option>
                <option value="Corporate">Corporate</option>
                <option value="Other">Other</option>
              </select>
              <label for="emailAudience">Replying to</label>
              <input
                type="text"
                class="form-control mt-2 d-none"
                id="audienceOther"
                placeholder="Enter other audience"
              />
            </div>

            <div class="mb-3 form-floating">
              <select class="form-select" id="emailTone" required="">
                <option value="Professional">Professional</option>
                <option value="Friendly">Friendly</option>
                <option value="Apologetic">Apologetic</option>
                <option value="Confident">Confident</option>
                <option value="Persuasive">Persuasive</option>
                <option value="Direct">Direct</option>
                <option value="Other">Other</option>
              </select>
              <label for="emailTone">Tone</label>
              <input
                type="text"
                class="form-control mt-2 d-none"
                id="toneOther"
                placeholder="Enter other tone"
              />
            </div>

            <div class="mb-3 form-floating">
              <select class="form-select" id="emailType">
                <option value="Provide Update">General Reply</option>
                <option value="Provide Update">Provide Update</option>
                <option value="Request Information">Request Information</option>
                <option value="Provide Account Information">
                  Provide Account Information
                </option>
                <option value="Provide Instructions">
                  Provide Instructions
                </option>
                <option value="Decline Request">Decline Request</option>
                <option value="Approve Request">Approve Request</option>
                <option value="Other">Other</option>
              </select>
              <label for="emailType">Type</label>
              <input
                type="text"
                class="form-control mt-2 d-none"
                id="typeOther"
                placeholder="Enter other type"
              />
            </div>

            <div class="mb-3 form-floating">
              <textarea
                class="form-control"
                id="emailDescription"
                rows="4"
                placeholder="Summarize the email you want to generate."
              ></textarea>
              <label for="emailDescription">Description</label>
            </div>

            <div class="mb-3">
              <label for="templateContent" class="form-label"
                >Optional Template</label
              >
              <div
                class="col overflow-scroll"
                id="templateContent"
                contenteditable="true"
              >
                Paste template content here...
              </div>
              <!--
          <input type="file" class="form-control" id="templateContent" />
              <div id="fileCardContainer" class="mt-3"></div>
          -->
            </div>
            <button id="openDialog">Open Modal Dialog</button>

            <button type="submit" class="btn btn-primary">
              Generate Reply
            </button>
          </form>
        </div>
      </div>
    </div>

    <div id="emailPreview" class="view"></div>

    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <!--
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
      //   let templateContent = null;
      let originalEmailBody = "";

      Office.onReady((info) => {
        if (info.host === Office.HostType.Outlook) {
          Office.context.mailbox.item.body.getAsync(
            Office.CoercionType.Text,
            (result) => {
              if (result.status === Office.AsyncResultStatus.Succeeded) {
                originalEmailBody = result.value;
              } else {
                console.error(
                  "Failed to get email body:",
                  result.error.message
                );
              }
            }
          );
        }
        const settingsBtn = document.getElementById("settingsBtn");
        if (settingsBtn) {
          settingsBtn.onclick = showSettings;
        }

        const saveBtn = document.getElementById("saveSettingsBtn");
        if (saveBtn) {
          saveBtn.onclick = saveSettings;
        }

        const backBtn = document.getElementById("cancelSettingsBtn");
        if (backBtn) {
          backBtn.onclick = goHome;
        }
      });

      window.onload = () =>
        document.getElementById("loadingSpinner").classList.remove("show");

      // Show/hide custom fields
      const showOtherInput = (selectId, inputId) => {
        document
          .getElementById(selectId)
          .addEventListener("change", function () {
            const input = document.getElementById(inputId);
            if (this.value === "Other") {
              input.classList.remove("d-none");
              input.required = true;
            } else {
              input.classList.add("d-none");
              input.required = false;
              input.value = "";
            }
          });
      };

      showOtherInput("emailAudience", "audienceOther");
      showOtherInput("emailTone", "toneOther");
      showOtherInput("emailType", "typeOther");

      let templateContent = "";
      const templateDiv = document.getElementById("templateContent");
      templateDiv.addEventListener("paste", (event) => {
        event.preventDefault();
        templateContent = event.clipboardData.getData("text/plain");
        templateDiv.innerHTML = event.clipboardData.getData("text/html");
      });

      // document
      //   .getElementById("templateContent")
      //   .addEventListener("change", function (e) {
      //     const file = e.target.files[0];
      //     const fileCardContainer =
      //       document.getElementById("fileCardContainer");

      //     if (file) {
      //       const maxSize = 5 * 1024 * 1024;
      //       if (file.size > maxSize) {
      //         console.log("File too large. Max 5MB.");
      //         e.target.value = "";
      //         templateContent = null;
      //         fileCardContainer.innerHTML = "";
      //         return;
      //       }

      //       const reader = new FileReader();
      //       reader.onload = function (event) {
      //         templateContent = {
      //           fileName: file.name,
      //           fileType: file.type,
      //           fileSize: file.size,
      //           base64Content: event.target.result.split(",")[1],
      //         };

      //         const fileSizeKB = (file.size / 1024).toFixed(1);
      //         fileCardContainer.innerHTML = `
      //       <div class="card shadow-sm fade-in">
      //         <div class="card-body">
      //           <h5 class="card-title">${file.name}</h5>
      //           <p><strong>Size:</strong> ${fileSizeKB} KB</p>
      //           <p><strong>Type:</strong> ${file.type || "Unknown"}</p>
      //           <button type="button" class="btn btn-sm btn-outline-danger" id="removeFileButton">Remove</button>
      //         </div>
      //       </div>
      //     `;

      //         document
      //           .getElementById("removeFileButton")
      //           .addEventListener("click", function () {
      //             document.getElementById("templateContent").value = "";
      //             templateContent = null;
      //             fileCardContainer.innerHTML = "";
      //           });
      //       };

      //       reader.readAsDataURL(file);
      //     }
      //   });

      document
        .getElementById("replyForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formContainer = document.getElementById("formContainer");
          const loadingSpinner = document.getElementById("loadingSpinner");
          const previewEmail = document.getElementById("emailPreview");

          formContainer.classList.add("blurred");
          loadingSpinner.classList.add("show");

          const emailAudience =
            document.getElementById("emailAudience").value === "Other"
              ? document.getElementById("audienceOther").value
              : document.getElementById("emailAudience").value;

          const emailTone =
            document.getElementById("emailTone").value === "Other"
              ? document.getElementById("toneOther").value
              : document.getElementById("emailTone").value;

          const emailType =
            document.getElementById("emailType").value === "Other"
              ? document.getElementById("typeOther").value
              : document.getElementById("emailType").value;

          const emailDescription =
            document.getElementById("emailDescription").value;

          const replyPrompt = {
            audience: emailAudience,
            tone: emailTone,
            type: emailType,
            description: emailDescription,
            template: templateContent,
            originalEmail: originalEmailBody,
          };

          try {
            const response = await fetch(
              "https://prod-145.westus.logic.azure.com:443/workflows/c65d371e274a4a29a0daa3ee25ce63bd/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=-skVHfpWefHb6DNSYMWTmkI3mEUObkxnK2wAvBwU-wg",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(replyPrompt),
              }
            );

            const result = await response.json();

            if (result.success && result.reply) {
              loadingSpinner.classList.remove("show");
              formContainer.classList.remove("active", "blurred");
              previewEmail.classList.add("active");

              if (Office.context.roamingSettings.get("includeSignature")) {
                const signature =
                  Office.context.roamingSettings.get("userSignature") ||
                  result.reply.signature;
                const newBody = result.reply.body + "<br>" + signature;
                result.reply.body = newBody;
              }

              previewEmail.innerHTML = `
            <div class="card-body fade-in">
                <h2 class="mb-4">Generated Reply</h2>
                <label class="mb-1">Subject:</label>
                <div class="card mb-3">
                  <div class="card-body overflow-scroll">
                    ${result.reply.subject}
                  </div>
                </div>
                <label class="mb-1">Body:</label>
                <div class="card mb-3">
                  <div class="card-body overflow-scroll">
                    ${result.reply.body}
                  </div>
                </div>
              <div class="card-footer bg-transparent mt-auto">
              <div class="btn-list justify-content-end">
                <a href="#" class="btn btn-1" id="cancelReplyButton">Cancel</a>
                <a href="#" class="btn btn-success btn-2" id="insertReplyButton">Insert into Email</a>
              </div>
            </div>
            </div>
          `;

              document
                .getElementById("insertReplyButton")
                .addEventListener("click", function () {
                  const item = Office.context.mailbox.item;

                  if (
                    Office.context.mailbox.item.itemType ===
                      Office.MailboxEnums.ItemType.Message &&
                    typeof item.body.setSelectedDataAsync === "function"
                  ) {
                    // Compose mode: insert text directly
                    item.body.setSelectedDataAsync(
                      insertReplyHtml,
                      { coercionType: Office.CoercionType.Text },
                      function (asyncResult) {
                        if (
                          asyncResult.status ===
                          Office.AsyncResultStatus.Succeeded
                        ) {
                          console.log("Reply inserted!");
                        } else {
                          console.error(
                            "Failed to insert reply:",
                            asyncResult.error.message
                          );
                        }
                      }
                    );
                  } else {
                    // Not in compose mode, launch new message
                    Office.context.mailbox.item.displayReplyAllFormAsync(
                      {
                        htmlBody: result.reply.body,
                      },
                      function (asyncResult) {
                        if (
                          asyncResult.status ===
                          Office.AsyncResultStatus.Succeeded
                        ) {
                          console.log("Reply inserted!");
                        } else {
                          console.error(
                            "Failed to insert reply:",
                            asyncResult.error.message
                          );
                        }
                      }
                    );
                  }
                  previewEmail.innerHTML = "";
                  goHome();
                });

              document
                .getElementById("cancelReplyButton")
                .addEventListener("click", function () {
                  previewEmail.innerHTML = "";
                  goHome();
                });

              document
                .getElementById("emailPreview")
                .scrollIntoView({ behavior: "smooth" });
            } else {
              console.log("Something went wrong. No reply text received.");
            }
          } catch (err) {
            console.error("Fetch error:", err);
            console.log("An error occurred while generating the reply.");
          }
        });

      function convertEscapedToHtml(input, options = {}) {
        if (!input || typeof input !== "string") return "";

        if (options.usePre) {
          return `<pre>${escapeHtml(input)}</pre>`;
        }

        return escapeHtml(input)
          .replace(/\n/g, "<br>")
          .replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
      }

      function escapeHtml(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function showSettings() {
        document.querySelector(".view.active").classList.remove("active");
        document.getElementById("settingsContainer").classList.add("active");
        const signatureHtml =
          Office.context.roamingSettings.get("userSignature") || "";
        document.getElementById("signatureInput").innerHTML = signatureHtml;
      }

      function goHome() {
        document.querySelector(".view.active").classList.remove("active");
        document.getElementById("formContainer").classList.add("active");
      }

      function saveSettings() {
        const signatureHtml =
          document.getElementById("signatureInput").innerHTML;
        const signatureSwitch =
          document.getElementById("includeSigChk").checked;

        Office.context.roamingSettings.set("userSignature", signatureHtml);
        Office.context.roamingSettings.set("includeSignature", signatureSwitch);

        Office.context.roamingSettings.saveAsync((result) => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            console.log("Settings saved successfully.");
            goHome();
          } else {
            console.log("Failed to save settings.");
          }
        });

        goHome();
      }
    </script>
    <script>
      Office.onReady(() => {
        document.getElementById("openDialog").onclick = () => {
          Office.context.ui.displayDialogAsync(
            "https://polluti0n.github.io/EmailGenie/dialog.html",
            { height: 50, width: 50 },
            function (asyncResult) {
              if (asyncResult.status === Office.AsyncResultStatus.Succeeded) {
                const dialog = asyncResult.value;

                dialog.addEventHandler(
                  Office.EventType.DialogMessageReceived,
                  function (arg) {
                    console.log("Message from dialog:", arg.message);
                    dialog.close();
                  }
                );
              } else {
                console.error(
                  "Failed to open dialog:",
                  asyncResult.error.message
                );
              }
            }
          );
        };
      });
    </script>
  </body>
</html>
