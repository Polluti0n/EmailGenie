<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Email Reply Generator</title>
    <!--
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css"
    />

    <style>
      .view {
        display: none;
      }
      .view.active {
        display: block;
      }
      #signatureInput {
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 100px;
      }

      .blurred {
        filter: blur(4px);
        pointer-events: none;
        user-select: none;
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .slide-up {
        animation: slideUp 0.5s forwards;
      }

      @keyframes slideUp {
        from {
          opacity: 1;
          transform: translateY(0);
          max-height: 1000px;
        }

        to {
          opacity: 0;
          transform: translateY(-50px);
          max-height: 0;
          overflow: hidden;
        }
      }

      #loadingSpinner {
        position: fixed;
        background: rgba(255, 255, 255, 0.7);
        z-index: 1050;
        top: 50%;
        left: 50%;
        translate: -50% -50%;
      }

      pre {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body class="p-4">
    <div
      id="loadingSpinner"
      class="d-flex justify-content-center align-items-center fade"
    >
      <div
        class="spinner-border text-primary"
        role="status"
        style="width: 4rem; height: 4rem"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div id="settingsContainer" class="view">
      <div class="card-body">
        <h2 class="mb-4">Settings</h2>

        <div class="mb-3">
          <h3 class="card-title mt-4">Signatures</h3>
          <label class="row mb-3">
            <span class="col">Include Signature</span>
            <span class="col-auto">
              <label class="form-check form-check-single form-switch">
                <input
                  id="includeSigChk"
                  class="form-check-input"
                  type="checkbox"
                  checked=""
                />
              </label>
            </span>
          </label>
          <div class="col" id="signatureInput" contenteditable="true">
            Paste your Outlook signature here...
          </div>
        </div>
      </div>
      <div class="card-footer bg-transparent mt-auto">
        <div class="btn-list justify-content-end">
          <a href="#" class="btn btn-1" id="cancelSettingsBtn"> Cancel </a>
          <a href="#" class="btn btn-primary btn-2" id="saveSettingsBtn"
            >Save</a
          >
        </div>
      </div>
    </div>

    <div id="formContainer" class="view active">
      <div class="card-body">
        <div class="mb-4 d-flex justify-content-between">
          <h2 class="col">Reply Detail</h2>
          <a id="settingsBtn">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="icon icon-tabler icons-tabler-filled icon-tabler-settings"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path
                d="M14.647 4.081a.724 .724 0 0 0 1.08 .448c2.439 -1.485 5.23 1.305 3.745 3.744a.724 .724 0 0 0 .447 1.08c2.775 .673 2.775 4.62 0 5.294a.724 .724 0 0 0 -.448 1.08c1.485 2.439 -1.305 5.23 -3.744 3.745a.724 .724 0 0 0 -1.08 .447c-.673 2.775 -4.62 2.775 -5.294 0a.724 .724 0 0 0 -1.08 -.448c-2.439 1.485 -5.23 -1.305 -3.745 -3.744a.724 .724 0 0 0 -.447 -1.08c-2.775 -.673 -2.775 -4.62 0 -5.294a.724 .724 0 0 0 .448 -1.08c-1.485 -2.439 1.305 -5.23 3.744 -3.745a.722 .722 0 0 0 1.08 -.447c.673 -2.775 4.62 -2.775 5.294 0zm-2.647 4.919a3 3 0 1 0 0 6a3 3 0 0 0 0 -6z"
              ></path>
            </svg>
          </a>
        </div>

        <div class="mb-3">
          <form id="replyForm">
            <div class="mb-3 form-floating">
              <select class="form-select" id="emailAudience" required="">
                <option value="">Select...</option>
                <option value="Client">Client</option>
                <option value="Coworker">Coworker</option>
                <option value="Corporate">Corporate</option>
                <option value="Other">Other</option>
              </select>
              <label for="emailAudience">Replying to</label>
              <input
                type="text"
                class="form-control mt-2 d-none"
                id="audienceOther"
                placeholder="Enter other audience"
              />
            </div>

            <div class="mb-3 form-floating">
              <select class="form-select" id="emailTone" required="">
                <option value="Professional">Professional</option>
                <option value="Friendly">Friendly</option>
                <option value="Apologetic">Apologetic</option>
                <option value="Confident">Confident</option>
                <option value="Persuasive">Persuasive</option>
                <option value="Direct">Direct</option>
                <option value="Other">Other</option>
              </select>
              <label for="emailTone">Tone</label>
              <input
                type="text"
                class="form-control mt-2 d-none"
                id="toneOther"
                placeholder="Enter other tone"
              />
            </div>

            <div class="mb-3 form-floating">
              <select class="form-select" id="emailType">
                <option value="Provide Update">General Reply</option>
                <option value="Provide Update">Provide Update</option>
                <option value="Request Information">Request Information</option>
                <option value="Provide Account Information">
                  Provide Account Information
                </option>
                <option value="Provide Instructions">
                  Provide Instructions
                </option>
                <option value="Decline Request">Decline Request</option>
                <option value="Approve Request">Approve Request</option>
                <option value="Other">Other</option>
              </select>
              <label for="emailType">Type</label>
              <input
                type="text"
                class="form-control mt-2 d-none"
                id="typeOther"
                placeholder="Enter other type"
              />
            </div>

            <div class="mb-3 form-floating">
              <textarea
                class="form-control"
                id="emailDescription"
                rows="4"
                placeholder="Summarize the email you want to generate."
              ></textarea>
              <label for="emailDescription">Description</label>
            </div>

            <div class="mb-3">
              <label for="templateContent" class="form-label"
                >Optional Template</label
              >
              <input type="file" class="form-control" id="templateContent" />
              <div id="fileCardContainer" class="mt-3"></div>
            </div>

            <button type="submit" class="btn btn-primary">
              Generate Reply
            </button>
          </form>
        </div>
      </div>
    </div>

    <div id="emailPreview"></div>

    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <!--
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>

    <script>
      let templateContent = null;
      let originalEmailBody = "";

      Office.onReady((info) => {
        if (info.host === Office.HostType.Outlook) {
          Office.context.mailbox.item.body.getAsync(
            Office.CoercionType.Text,
            (result) => {
              if (result.status === Office.AsyncResultStatus.Succeeded) {
                originalEmailBody = result.value;
              } else {
                console.error(
                  "Failed to get email body:",
                  result.error.message
                );
              }
            }
          );
        }
        const settingsBtn = document.getElementById("settingsBtn");
        if (settingsBtn) {
          settingsBtn.onclick = showSettings;
        }

        const saveBtn = document.getElementById("saveSettingsBtn");
        if (saveBtn) {
          saveBtn.onclick = saveSettings;
        }

        const backBtn = document.getElementById("cancelSettingsBtn");
        if (backBtn) {
          backBtn.onclick = closeSettings;
        }
      });

      window.onload = () =>
        document.getElementById("loadingSpinner").classList.remove("show");

      // Show/hide custom fields
      const showOtherInput = (selectId, inputId) => {
        document
          .getElementById(selectId)
          .addEventListener("change", function () {
            const input = document.getElementById(inputId);
            if (this.value === "Other") {
              input.classList.remove("d-none");
              input.required = true;
            } else {
              input.classList.add("d-none");
              input.required = false;
              input.value = "";
            }
          });
      };

      showOtherInput("emailAudience", "audienceOther");
      showOtherInput("emailTone", "toneOther");
      showOtherInput("emailType", "typeOther");

      document
        .getElementById("templateContent")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          const fileCardContainer =
            document.getElementById("fileCardContainer");

          if (file) {
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
              alert("File too large. Max 5MB.");
              e.target.value = "";
              templateContent = null;
              fileCardContainer.innerHTML = "";
              return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
              templateContent = {
                fileName: file.name,
                fileType: file.type,
                fileSize: file.size,
                base64Content: event.target.result.split(",")[1],
              };

              const fileSizeKB = (file.size / 1024).toFixed(1);
              fileCardContainer.innerHTML = `
            <div class="card shadow-sm fade-in">
              <div class="card-body">
                <h5 class="card-title">${file.name}</h5>
                <p><strong>Size:</strong> ${fileSizeKB} KB</p>
                <p><strong>Type:</strong> ${file.type || "Unknown"}</p>
                <button type="button" class="btn btn-sm btn-outline-danger" id="removeFileButton">Remove</button>
              </div>
            </div>
          `;

              document
                .getElementById("removeFileButton")
                .addEventListener("click", function () {
                  document.getElementById("templateContent").value = "";
                  templateContent = null;
                  fileCardContainer.innerHTML = "";
                });
            };

            reader.readAsDataURL(file);
          }
        });

      document
        .getElementById("replyForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formContainer = document.getElementById("formContainer");
          const loadingSpinner = document.getElementById("loadingSpinner");

          formContainer.classList.add("blurred");
          loadingSpinner.classList.add("show");

          const emailAudience =
            document.getElementById("emailAudience").value === "Other"
              ? document.getElementById("audienceOther").value
              : document.getElementById("emailAudience").value;

          const emailTone =
            document.getElementById("emailTone").value === "Other"
              ? document.getElementById("toneOther").value
              : document.getElementById("emailTone").value;

          const emailType =
            document.getElementById("emailType").value === "Other"
              ? document.getElementById("typeOther").value
              : document.getElementById("emailType").value;

          const emailDescription =
            document.getElementById("emailDescription").value;

          const replyPrompt = {
            audience: emailAudience,
            tone: emailTone,
            type: emailType,
            description: emailDescription,
            template: templateContent,
            originalEmail: originalEmailBody,
          };

          try {
            const response = await fetch(
              "https://prod-145.westus.logic.azure.com:443/workflows/c65d371e274a4a29a0daa3ee25ce63bd/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=-skVHfpWefHb6DNSYMWTmkI3mEUObkxnK2wAvBwU-wg",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(replyPrompt),
              }
            );

            const result = await response.json();

            if (result.success && result.reply) {
              loadingSpinner.classList.remove("show");
              formContainer.classList.add("slide-up");

              document.getElementById("emailPreview").innerHTML = `
            <div class="fade-in">
              <h5 class="card-title mb-3">Generated Reply</h5>
              <pre>Subject: ${result.reply.subject}</pre>
              <pre>Body: ${result.reply.body}</pre>
              <button class="btn btn-success mt-3" id="insertReplyButton">Insert into Email</button>
            </div>
          `;

              document
                .getElementById("insertReplyButton")
                .addEventListener("click", function () {
                  const insertReplyHtml = `<p>${convertEscapedToHtml(
                    result.reply.body
                  )}</p>`;
                  const item = Office.context.mailbox.item;

                  if (
                    Office.context.mailbox.item.itemType ===
                      Office.MailboxEnums.ItemType.Message &&
                    typeof item.body.setSelectedDataAsync === "function"
                  ) {
                    // Compose mode: insert text directly
                    item.body.setSelectedDataAsync(
                      insertReplyHtml,
                      { coercionType: Office.CoercionType.Text },
                      function (asyncResult) {
                        if (
                          asyncResult.status ===
                          Office.AsyncResultStatus.Succeeded
                        ) {
                          console.log("Reply inserted!");
                        } else {
                          console.error(
                            "Failed to insert reply:",
                            asyncResult.error.message
                          );
                        }
                      }
                    );
                  } else {
                    // Not in compose mode, launch new message
                    Office.context.mailbox.item.displayReplyAllFormAsync(
                      {
                        htmlBody: insertReplyHtml,
                      },
                      function (asyncResult) {
                        if (
                          asyncResult.status ===
                          Office.AsyncResultStatus.Succeeded
                        ) {
                          console.log("Reply inserted!");
                        } else {
                          console.error(
                            "Failed to insert reply:",
                            asyncResult.error.message
                          );
                        }
                      }
                    );
                  }
                });

              document
                .getElementById("emailPreview")
                .scrollIntoView({ behavior: "smooth" });
            } else {
              alert("Something went wrong. No reply text received.");
            }
          } catch (err) {
            console.error("Fetch error:", err);
            alert("An error occurred while generating the reply.");
          }
        });

      function convertEscapedToHtml(input, options = {}) {
        if (!input || typeof input !== "string") return "";

        if (options.usePre) {
          return `<pre>${escapeHtml(input)}</pre>`;
        }

        return escapeHtml(input)
          .replace(/\n/g, "<br>")
          .replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
      }

      /**
       * Escapes HTML special characters to avoid injection issues
       * @param {string} str
       * @returns {string}
       */
      function escapeHtml(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function showSettings() {
        document.querySelector(".view.active").classList.remove("active");
        document.getElementById("settingsContainer").classList.add("active");
        const signatureHtml =
          Office.context.roamingSettings.get("userSignature") || "";
        document.getElementById("signatureInput").innerHTML = signatureHtml;
      }

      function closeSettings() {
        document.querySelector(".view.active").classList.remove("active");
        document.getElementById("formContainer").classList.add("active");
      }

      function saveSettings() {
        const signatureHtml =
          document.getElementById("signatureInput").innerHTML;
        const signatureSwitch =
          document.getElementById("includeSigChk").checked;

        Office.context.roamingSettings.set("userSignature", signatureHtml);
        Office.content.roamingSettings.set("includeSignature", signatureSwitch);
        Office.context.roamingSettings.saveAsync((result) => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            console.log("Settings saved successfully.");
            goBack();
          } else {
            console.log("Failed to save settings.");
          }
        });
        closeSettings();
      }
    </script>
  </body>
</html>
