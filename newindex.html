<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Email Reply Generator</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css"
    />
    <link rel="stylesheet" href="./css/tabler-themes.css" />
    <link rel="stylesheet" href="./css/base.css" />
  </head>

  <body>
    <!-- BEGIN GLOBAL THEME SCRIPT -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script src="./js/emailgenie-theme.js" defer=""></script>
    <!-- END GLOBAL THEME SCRIPT -->

    <div class="page">
      <div class="page-wrapper p-2">
        <div class="row row-deck row-cards">
          <div class="card card-sm">
            <div class="d-flex">
              <div class="card-body">
                <div class="col">
                  <div class="mb-1 col">Summary</div>
                  <div class="text-secondary w-100">
                    Some summary text goes here.
                  </div>
                </div>
              </div>
              <div>
                <a href="#" class="link-secondary"
                  ><!-- Download SVG icon from http://tabler.io/icons/icon/share -->
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-right"
                  >
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M9 6l6 6l-6 6"></path>
                  </svg>
                </a>
              </div>
            </div>
          </div>
          <div class="card card-sm">
            <div class="card-body">
              <div class="mb-1 col">Quick Reply</div>
              <div class="list-group list-group-flush">
                <span
                  class="list-group-item text-secondary rounded p-2"
                  aria-current="true"
                >
                  The current link item
                </span>
                <span class="list-group-item text-secondary rounded p-2"
                  >A second link item</span
                >
                <span class="list-group-item text-secondary rounded p-2"
                  >A third link item</span
                >
                <span class="list-group-item text-secondary rounded p-2"
                  >A fourth link item</span
                >
              </div>
            </div>
            <div class="d-flex"></div>
          </div>
        </div>
      </div>

      <!-- BEGIN SETTINGS CONTAINER  -->
      <div id="" class="card">
        <ul class="nav nav-pills card-footer-pills text-center nav-justified">
          <li class="nav-item">
            <a class="nav-link" href="#">
              <div class="col">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-sparkles"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path
                    d="M16 18a2 2 0 0 1 2 2a2 2 0 0 1 2 -2a2 2 0 0 1 -2 -2a2 2 0 0 1 -2 2zm0 -12a2 2 0 0 1 2 2a2 2 0 0 1 2 -2a2 2 0 0 1 -2 -2a2 2 0 0 1 -2 2zm-7 12a6 6 0 0 1 6 -6a6 6 0 0 1 -6 -6a6 6 0 0 1 -6 6a6 6 0 0 1 6 6z"
                  ></path>
                </svg>
                <div>Improve</div>
              </div></a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <div class="col">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-writing"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path
                    d="M20 17v-12c0 -1.121 -.879 -2 -2 -2s-2 .879 -2 2v12l2 2l2 -2z"
                  ></path>
                  <path d="M16 7h4"></path>
                  <path
                    d="M18 19h-13a2 2 0 1 1 0 -4h4a2 2 0 1 0 0 -4h-3"
                  ></path>
                </svg>
                <div>Reply</div>
              </div></a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <div class="col">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-at"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"></path>
                  <path
                    d="M16 12v1.5a2.5 2.5 0 0 0 5 0v-1.5a9 9 0 1 0 -5.5 8.28"
                  ></path>
                </svg>
                <div>Compose</div>
              </div></a
            >
          </li>

          <li class="nav-item">
            <a class="nav-link" href="#">
              <div class="col">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon icon-1"
                >
                  <path
                    d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z"
                  ></path>
                  <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"></path>
                </svg>
                <div>Settings</div>
              </div></a
            >
          </li>
        </ul>
      </div>
      <!-- END SETTINGS CONTAINER  -->

      <!-- BEGIN LOADING SPINNER  -->
      <div
        id="loadingSpinner"
        class="d-flex justify-content-center align-items-center fade"
      >
        <div
          class="spinner-border text-primary"
          role="status"
          style="width: 4rem; height: 4rem"
        >
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <!-- BEGIN GLOBAL MANDATORY SCRIPTS -->
      <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
      <!-- END GLOBAL MANDATORY SCRIPTS -->

      <!-- BEGIN MANDATORY PAGE THEME SCRIPT -->
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          var themeConfig = {
            theme: "light",
            "theme-base": "gray",
            "theme-font": "sans-serif",
            "theme-primary": "blue",
            "theme-radius": "1",
          };

          var url = new URL(window.location);
          var form = document.getElementById("offcanvasSettings");
          var resetButton = document.getElementById("reset-changes");

          var applyThemeValue = function (key, value) {
            document.documentElement.setAttribute("data-bs-" + key, value);
            window.localStorage.setItem("tabler-" + key, value);
            Office.context.roamingSettings.set("tabler-" + key, value);
          };

          var checkItems = function () {
            for (var key in themeConfig) {
              let stored =
                Office.context.roamingSettings.get("tabler-" + key) ||
                window.localStorage.getItem("tabler-" + key) ||
                themeConfig[key];

              if (stored) {
                document.documentElement.setAttribute("data-bs-" + key, stored);

                var radios = form.querySelectorAll(`[name="${key}"]`);
                if (radios) {
                  radios.forEach((radio) => {
                    radio.checked = radio.value === stored;
                  });
                }
              }
            }
          };

          form.addEventListener("change", function (event) {
            var target = event.target,
              name = target.name,
              value = target.value;

            for (var key in themeConfig) {
              if (name === key) {
                applyThemeValue(key, value);
                url.searchParams.set(key, value);
              }
            }
            Office.context.roamingSettings.saveAsync(); // persist settings
          });

          resetButton.addEventListener("click", function () {
            for (var key in themeConfig) {
              var defaultValue = themeConfig[key];
              document.documentElement.removeAttribute("data-bs-" + key);
              window.localStorage.removeItem("tabler-" + key);
              Office.context.roamingSettings.remove("tabler-" + key);
              url.searchParams.delete(key);
            }

            Office.context.roamingSettings.saveAsync(); // persist settings
            checkItems();
          });

          Office.onReady(function () {
            checkItems();
          });
        });
      </script>
      <!-- END MANDATORY PAGE THEME SCRIPT -->

      <!-- BEGIN PAGE SCRIPT -->
      <script>
        //   let templateContent = null;
        let originalEmailBody = "";
        Office.onReady((info) => {
          if (info.host === Office.HostType.Outlook) {
            Office.context.mailbox.item.body.getAsync(
              Office.CoercionType.Text,
              (result) => {
                if (result.status === Office.AsyncResultStatus.Succeeded) {
                  originalEmailBody = result.value;
                } else {
                  console.error(
                    "Failed to get email body:",
                    result.error.message
                  );
                }
              }
            );
          }
          const settingsBtn = document.getElementById("settingsBtn");
          if (settingsBtn) {
            settingsBtn.onclick = showSettings;
          }

          const saveBtn = document.getElementById("saveSettingsBtn");
          if (saveBtn) {
            saveBtn.onclick = saveSettings;
          }

          const backBtn = document.getElementById("cancelSettingsBtn");
          if (backBtn) {
            backBtn.onclick = goHome;
          }
        });

        window.onload = () =>
          document.getElementById("loadingSpinner").classList.remove("show");

        // Show/hide custom fields
        const showOtherInput = (selectId, inputId) => {
          document
            .getElementById(selectId)
            .addEventListener("change", function () {
              const input = document.getElementById(inputId);
              if (this.value === "Other") {
                input.classList.remove("d-none");
                input.required = true;
              } else {
                input.classList.add("d-none");
                input.required = false;
                input.value = "";
              }
            });
        };

        showOtherInput("emailAudience", "audienceOther");
        showOtherInput("emailTone", "toneOther");
        showOtherInput("emailType", "typeOther");

        let templateContent = "";
        const templateDiv = document.getElementById("templateContent");
        templateDiv.addEventListener("paste", (event) => {
          event.preventDefault();
          templateContent = event.clipboardData.getData("text/plain");
          templateDiv.innerHTML = event.clipboardData.getData("text/html");
        });

        document
          .getElementById("replyForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            const formContainer = document.getElementById("formContainer");
            const loadingSpinner = document.getElementById("loadingSpinner");
            const previewEmail = document.getElementById("emailPreview");

            formContainer.classList.add("blurred");
            loadingSpinner.classList.add("show");

            const emailAudience =
              document.getElementById("emailAudience").value === "Other"
                ? document.getElementById("audienceOther").value
                : document.getElementById("emailAudience").value;

            const emailTone =
              document.getElementById("emailTone").value === "Other"
                ? document.getElementById("toneOther").value
                : document.getElementById("emailTone").value;

            const emailType =
              document.getElementById("emailType").value === "Other"
                ? document.getElementById("typeOther").value
                : document.getElementById("emailType").value;

            const emailDescription =
              document.getElementById("emailDescription").value;

            const replyPrompt = {
              audience: emailAudience,
              tone: emailTone,
              type: emailType,
              description: emailDescription,
              template: templateContent,
              originalEmail: originalEmailBody,
            };

            try {
              const response = await fetch(
                "https://prod-145.westus.logic.azure.com:443/workflows/c65d371e274a4a29a0daa3ee25ce63bd/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=-skVHfpWefHb6DNSYMWTmkI3mEUObkxnK2wAvBwU-wg",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(replyPrompt),
                }
              );

              const result = await response.json();

              if (result.success && result.reply) {
                loadingSpinner.classList.remove("show");
                formContainer.classList.remove("active", "blurred");
                previewEmail.classList.add("active");

                if (Office.context.roamingSettings.get("includeSignature")) {
                  const signature =
                    Office.context.roamingSettings.get("userSignature") ||
                    result.reply.signature;
                  const newBody = result.reply.body + "<br>" + signature;
                  result.reply.body = newBody;
                }

                previewEmail.innerHTML = `
            <div class="card-body fade-in">
                <h2 class="mb-4">Generated Reply</h2>
                <label class="mb-1">Subject:</label>
                <div class="card mb-3">
                  <div class="card-body overflow-scroll">
                    ${result.reply.subject}
                  </div>
                </div>
                <label class="mb-1">Body:</label>
                <div class="card mb-3">
                  <div class="card-body overflow-scroll">
                    ${result.reply.body}
                  </div>
                </div>
              <div class="card-footer bg-transparent mt-auto">
              <div class="btn-list justify-content-end">
                <a href="#" class="btn btn-1" id="cancelReplyButton">Cancel</a>
                <a href="#" class="btn btn-success btn-2" id="insertReplyButton">Insert into Email</a>
              </div>
            </div>
            </div>
          `;

                document
                  .getElementById("insertReplyButton")
                  .addEventListener("click", function () {
                    const item = Office.context.mailbox.item;

                    if (
                      Office.context.mailbox.item.itemType ===
                        Office.MailboxEnums.ItemType.Message &&
                      typeof item.body.setSelectedDataAsync === "function"
                    ) {
                      // Compose mode: insert text directly
                      item.body.setSelectedDataAsync(
                        insertReplyHtml,
                        { coercionType: Office.CoercionType.Text },
                        function (asyncResult) {
                          if (
                            asyncResult.status ===
                            Office.AsyncResultStatus.Succeeded
                          ) {
                            console.log("Reply inserted!");
                          } else {
                            console.error(
                              "Failed to insert reply:",
                              asyncResult.error.message
                            );
                          }
                        }
                      );
                    } else {
                      // Not in compose mode, launch new message
                      Office.context.mailbox.item.displayReplyAllFormAsync(
                        {
                          htmlBody: result.reply.body,
                        },
                        function (asyncResult) {
                          if (
                            asyncResult.status ===
                            Office.AsyncResultStatus.Succeeded
                          ) {
                            console.log("Reply inserted!");
                          } else {
                            console.error(
                              "Failed to insert reply:",
                              asyncResult.error.message
                            );
                          }
                        }
                      );
                    }
                    previewEmail.innerHTML = "";
                    goHome();
                  });

                document
                  .getElementById("cancelReplyButton")
                  .addEventListener("click", function () {
                    previewEmail.innerHTML = "";
                    goHome();
                  });

                document
                  .getElementById("emailPreview")
                  .scrollIntoView({ behavior: "smooth" });
              } else {
                console.log("Something went wrong. No reply text received.");
              }
            } catch (err) {
              console.error("Fetch error:", err);
              console.log("An error occurred while generating the reply.");
            }
          });

        function convertEscapedToHtml(input, options = {}) {
          if (!input || typeof input !== "string") return "";

          if (options.usePre) {
            return `<pre>${escapeHtml(input)}</pre>`;
          }

          return escapeHtml(input)
            .replace(/\n/g, "<br>")
            .replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
        }

        function escapeHtml(str) {
          return str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        function showSettings() {
          document.querySelector(".view.active").classList.remove("active");
          document.getElementById("settingsContainer").classList.add("active");
          const signatureHtml =
            Office.context.roamingSettings.get("userSignature") || "";
          document.getElementById("signatureInput").innerHTML = signatureHtml;
        }

        function goHome() {
          document.querySelector(".view.active").classList.remove("active");
          document.getElementById("formContainer").classList.add("active");
        }

        function saveSettings() {
          const signatureHtml =
            document.getElementById("signatureInput").innerHTML;
          const signatureSwitch =
            document.getElementById("includeSigChk").checked;

          Office.context.roamingSettings.set("userSignature", signatureHtml);
          Office.context.roamingSettings.set(
            "includeSignature",
            signatureSwitch
          );

          Office.context.roamingSettings.saveAsync((result) => {
            if (result.status === Office.AsyncResultStatus.Succeeded) {
              console.log("Settings saved successfully.");
              goHome();
            } else {
              console.log("Failed to save settings.");
            }
          });

          goHome();
        }
      </script>
      <script>
        Office.onReady(() => {
          document.getElementById("openDialog").onclick = () => {
            Office.context.ui.displayDialogAsync(
              "https://polluti0n.github.io/EmailGenie/dialog.html",
              { height: 50, width: 50 },
              function (asyncResult) {
                if (asyncResult.status === Office.AsyncResultStatus.Succeeded) {
                  const dialog = asyncResult.value;

                  dialog.addEventHandler(
                    Office.EventType.DialogMessageReceived,
                    function (arg) {
                      console.log("Message from dialog:", arg.message);
                      dialog.close();
                    }
                  );
                } else {
                  console.error(
                    "Failed to open dialog:",
                    asyncResult.error.message
                  );
                }
              }
            );
          };
        });
      </script>
      <!-- END PAGE SCRIPT -->
    </div>
  </body>
</html>
